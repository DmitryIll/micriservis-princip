
# Домашнее задание к занятию «Микросервисы: принципы» - Илларионов Дмитрий

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

### Решение

Поискал в интернете: есть множество продуктов для использования API GateWay, и практически все они выполняют перечисленные требования.

Напиример, даже просто на NGINX можно сделать API Gate Way.
Но, есть и более специализированные инструменты, которые дают дополнительные функции, например Web интерфейс для конфигурирования и др. Т.е. специализированными средствами может быть удобнее пользоваться, масштабировать и т.п.
Но, для простых решений можно использовать широко распространенный и производительный и многофункциональный - nginx.


Собрал информацию:

| Решение         | Маршрутизация запросов | Проверка аутентификации | Обеспечение терминации HTTPS |
|---|---|---|---|---|
| APIGee | ✔ | ✔ | ✔  
| Apache APISIX | ✔ | ✔ | ✔ | 
| Axway | ✔ | ✔ | ✔ | 
| Kong | ✔ | ✔ | ✔ | 
| Tyk | ✔ | ✔ | ✔ | 
| NGINX | ✔ | ✔ | ✔ | 
| NGINX Plus | ✔ | ✔ | ✔ | 
| Gravitee.io | ✔ | ✔ | ✔ | 
| AWS API Gateway | ✔ | ✔ | ✔ | 
| Azure Gateway | ✔ | ✔ | ✔ | 
| Ambassador | ✔ | ✔ | ✔ |
 
И это не полный набор, есть еще например, HAProxy на нем тоже можно выполнить API GateWay.
У облачных провайдеров есть свои облачные сервисы API GateWay.
По собранной информации, наиболе популярен API Gateway Kong. 


Есть бесплатные есть платные.

#### NGINX

По моему опыту самый широко используемый продукт - это NGINX.
Его и предлагаю использовать.
Преимущества:
-Бесплатный
-Широко известный - много документации и примеров.
-лучше иметь минимум ПО для простоты обслуживания, если функционала достаточно. Чем проще - лучше, легче поддерживать, минимум затрат на изучение.
-Легковестный, быстрый, производительный. 
-На нем можно размещать простые статичные сайты, например можно свой сайт авторизации сделать.
-Еще можно использовать встроенные средства авторизации - файл .htpasswd (это уже несколько другой функционал).

https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/

-Можно пропускать высокую нагркзу
-В сочетании с Keepalive IP можно делать резервирование.
-Можно сделать https и его терминацию, т.е. на входе с https, а далее переадресация на внутренние бэкенды по http.
-мощный функционал.
-есть стандартные логи, которые можно потом собирать и анализировать в ELK. Есть и идругие средства анализа логов Nginx. 
-Есть готовые образы-докер NGINX - их легко использовать - конфигурировать - собирать сови докер-образы для своих целей, с минимальными затратами.


## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

Собрал информацию:

| Брокер сообщений | Кластеризация | Хранение сообщений | Скорость работы | Поддержка форматов сообщений | Разделение прав доступа | Простота эксплуатации |
|---|---|---|---|---|---|---|
| Apache Kafka | Да | Да | Высокая | JSON, Avro, Protobuf, Binary | Да | Средняя |
| RabbitMQ | Да | Да | Средняя | JSON, XML, AMQP, MQTT | Да | Высокая |
| ActiveMQ | Да | Да | Средняя | JSON, XML, SOAP, STOMP | Да | Средняя |
| Redis | Да | Нет | Высокая | JSON, Strings, Lists, Sets, Hashes | Нет | Высокая |
| Beanstalk | Нет | Нет | Средняя | JSON, Strings | Нет | Средняя |

Я бы выбрал RabbitMQ, т.к. достаточно простой, быстрый, современный и много функциональный. Можно делать кластер, есть хранение данных на диске. Широко используется, много примеров, современное средство.
Более функционален вариант - Apache Kafka - но, более сложное решение, потребуется время на освоение.
Поэтому для простоты - RabbitMQ - для малых и средних проектов. Если проект масштабный, и будут ресурсы и время на освоение, можно выбрать Apache Kafka. Apache Kafka более производительное решение, и более функциональное.
Rabbit MQ - Уступает по скорости, но, надежен и прост и для малых и средних проектов оптимально его использовать (конечно зависит от ситуации, от имеющихся навыков команды разработки).


* **Apache Kafka** является лучшим выбором для приложений, которым требуется высокая скорость работы, кластеризация и хранение сообщений на диске. Kafka также поддерживает различные форматы сообщений и разделение прав доступа. Однако Kafka сложнее в эксплуатации, чем другие брокеры сообщений.
* **RabbitMQ** является хорошим выбором для приложений, которым требуется высокая надежность, кластеризация и поддержка различных форматов сообщений. RabbitMQ также прост в эксплуатации. Однако RabbitMQ не так быстр, как Kafka.
* **ActiveMQ** является также хорошим выбором для приложений, которым требуется высокая надежность, кластеризация и поддержка различных форматов сообщений. ActiveMQ также прост в эксплуатации. Однако ActiveMQ не так быстр, как Kafka и RabbitMQ.
* **Redis** является тоже хорошим выбором для приложений, которым требуется высокая скорость работы и простота эксплуатации. Redis также поддерживает различные форматы сообщений. Однако Redis не поддерживает хранение сообщений на диске по умолчанию и не предназначен для этих целей. Но все же можно включить функцию для хранения сообщений на диске, именуемую Персистентностью, только это приведет к снижения производительности Redis.
* **Beanstalk** является хорошим выбором для приложений, которым требуется высокая скорость работы и простота эксплуатации. Beanstalk также поддерживает различные форматы сообщений. Однако Beanstalk не поддерживает кластеризацию и хранение сообщений на диске.

## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

**minio**
- хранит загруженные файлы в бакете images,
- S3 протокол,

**uploader**
- принимает файл, если картинка сжимает и загружает его в minio,
- POST /v1/upload,

**security**
- регистрация пользователя POST /v1/user,
- получение информации о пользователе GET /v1/user,
- логин пользователя POST /v1/token,
- проверка токена GET /v1/token/validation.

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

**POST /v1/register**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/user.

**POST /v1/token**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/token.

**GET /v1/user**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис security GET /v1/user.

**POST /v1/upload**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис uploader POST /v1/upload.

**GET /v1/user/{image}**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис minio GET /images/{image}.

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл, запустив который можно локально выполнить следующие команды с успешным результатом.
Предполагается, что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки, который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов.
Авторизация
curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

**Загрузка файла**

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

**Получение файла**
curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg


### Решение

#### Вопросы

1. В коде server.py был порт 8060 а в докер-компосе - порт 3000, поэтому в коде server.py поменял на порт 3000. Верно?

2. Создал бакет:

![alt text](image.png)

Создал пользователя:

![alt text](image-1.png)

Права доступа:
![alt text](image-2.png)

Но, как определить переменные в .env :

```
Storage_Bucket=data
Storage_AccessKey=storage
Storage_Secret=qwerty123456
```
Что сюда нужно укзаать, и как это получить (создать)?

3. В коде докер компоса есть переменная "STORAGE_SECRET_KEY" а она не определена в .env ее нужно определить? т.е. то что в .env Storage_Secret - нужно переименовать на STORAGE_SECRET_KEY ? От куда взять значение этих переменных?

4. Как вообще указать путь к моему бакету? идентификтор яндекса может нужно? Это в data нужно что-то указать? Что именно?

5. Верно ли (хотя бы примерно) я сделал конфиг NGNX?

5. Как правпильно прописать пересылку запросов картинки? там же имя файла нужно еще прицепить?

6. Для POST /v1/register я пока сделал перенаправление на /status - типа заглушку. Но, в задании видимо опечатка или специально ошибка, 

```
Запрос направляется в сервис security POST /v1/user. 
```

- тут видимо опечкта, нужно так:

```
Запрос направляется в сервис security POST /v1/register
```

7. Нашел пример в интернете для nginx, вопрос, зачем в примере указано:

```
             proxy_set_header        Content-Length "";
             proxy_set_header        X-Original-URI $request_uri;
```

Что это означате,  и для чего?

8. Что в $request_uri ? Указывается ли там имя сервера, или только то что после имени сервера?

Хотел бы разобраться с этим ДЗ и получить рабочий вариант. Но, пока много вопросов.

---

#### [Дополнительные материалы: как запускать, как тестировать, как проверить](https://github.com/netology-code/devkub-homeworks/tree/main/11-microservicesё-02-principles)

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
